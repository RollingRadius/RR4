# Production overrides for docker-compose
# Use with: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up

version: '3.8'

services:
  postgres:
    # Remove port exposure in production (only internal access)
    ports: []
    environment:
      POSTGRES_PASSWORD: ${DB_PASSWORD}  # Use environment variable
    networks:
      - backend-internal

  redis:
    # Remove port exposure in production
    ports: []
    networks:
      - backend-internal

  backend:
    build:
      target: production  # Use production stage
    env_file:
      - .env.production
    environment:
      DATABASE_URL: postgresql://${DB_USER}:${DB_PASSWORD}@postgres:5432/${DB_NAME}
      DB_HOST: postgres
      DB_PORT: 5432
      ENVIRONMENT: production
    # Remove volume mounts (no hot reload in production)
    volumes:
      - ./uploads:/app/uploads
      - ./logs:/app/logs
    networks:
      - backend-internal
      - frontend
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4

networks:
  backend-internal:
    driver: bridge
    internal: true  # No external access
  frontend:
    driver: bridge
