# Fleet Management System - Backend Makefile
# Convenient commands for Docker operations

.PHONY: help build up down restart logs shell db-init db-reset db-migrate clean prod-build prod-up prod-down prod-logs

# Default target
help:
	@echo "Fleet Management System - Backend Commands"
	@echo "==========================================="
	@echo ""
	@echo "Development Commands:"
	@echo "  make build        - Build development Docker images"
	@echo "  make up           - Start all services (development)"
	@echo "  make down         - Stop all services"
	@echo "  make restart      - Restart all services"
	@echo "  make logs         - View logs (Ctrl+C to exit)"
	@echo "  make shell        - Open shell in backend container"
	@echo ""
	@echo "Production Commands:"
	@echo "  make prod-build   - Build production Docker images"
	@echo "  make prod-up      - Start production services"
	@echo "  make prod-down    - Stop production services"
	@echo "  make prod-logs    - View production logs"
	@echo "  make prod-shell   - Open shell in production backend"
	@echo ""
	@echo "Database Commands:"
	@echo "  make db-init      - Initialize database (create tables)"
	@echo "  make db-reset     - âš ï¸  DELETE ALL DATA and reset database"
	@echo "  make db-migrate   - Run Alembic migrations"
	@echo "  make db-shell     - Open PostgreSQL shell"
	@echo ""
	@echo "Cleanup Commands:"
	@echo "  make clean        - Stop services and remove volumes"
	@echo "  make clean-all    - Remove everything (images, volumes, networks)"
	@echo ""

# Build Docker images
build:
	@echo "ğŸ”¨ Building Docker images..."
	docker-compose build

# Start all services
up:
	@echo "ğŸš€ Starting all services..."
	docker-compose up -d
	@echo "âœ… Services started!"
	@echo "ğŸ“ Backend API: http://localhost:8000"
	@echo "ğŸ“ API Docs: http://localhost:8000/docs"
	@echo "ğŸ“ PostgreSQL: localhost:5432"
	@echo "ğŸ“ Redis: localhost:6379"

# Stop all services
down:
	@echo "ğŸ›‘ Stopping all services..."
	docker-compose down
	@echo "âœ… Services stopped"

# Restart all services
restart:
	@echo "ğŸ”„ Restarting all services..."
	docker-compose restart
	@echo "âœ… Services restarted"

# View logs
logs:
	@echo "ğŸ“œ Viewing logs (Ctrl+C to exit)..."
	docker-compose logs -f

# Open shell in backend container
shell:
	@echo "ğŸš Opening shell in backend container..."
	docker-compose exec backend /bin/bash

# Initialize database
db-init:
	@echo "ğŸ”§ Initializing database..."
	docker-compose exec backend python init-db.py

# Reset database (with confirmation)
db-reset:
	@echo "âš ï¸  WARNING: This will DELETE ALL DATA!"
	docker-compose exec -it backend python reset-db.py

# Run Alembic migrations
db-migrate:
	@echo "ğŸ”„ Running database migrations..."
	docker-compose exec backend alembic upgrade head
	@echo "âœ… Migrations complete"

# Open PostgreSQL shell
db-shell:
	@echo "ğŸš Opening PostgreSQL shell..."
	docker-compose exec postgres psql -U fleet_user -d fleet_db

# Clean up (stop services and remove volumes)
clean:
	@echo "ğŸ§¹ Cleaning up..."
	docker-compose down -v
	@echo "âœ… Cleanup complete"

# Clean everything (images, volumes, networks)
clean-all:
	@echo "ğŸ§¹ Removing everything..."
	docker-compose down -v --rmi all --remove-orphans
	@echo "âœ… All cleaned up"

# Quick start (build and start)
start: build up db-migrate
	@echo "âœ¨ Application started successfully!"
	@echo "ğŸ“ Visit http://localhost:8000/docs"

# Full reset and restart
reset-start: clean build up db-migrate
	@echo "âœ¨ Application reset and started successfully!"

# ============================================================================
# Production Commands
# ============================================================================

# Build production images
prod-build:
	@echo "ğŸ”¨ Building production Docker images..."
	docker-compose -f docker-compose.prod.yml build --no-cache
	@echo "âœ… Production images built"

# Start production services
prod-up:
	@echo "ğŸš€ Starting production services..."
	docker-compose -f docker-compose.prod.yml up -d
	@echo "âœ… Production services started!"
	@echo "ğŸ“ Backend API: http://localhost:8000"
	@echo "ğŸ“ API Docs: http://localhost:8000/docs"

# Stop production services
prod-down:
	@echo "ğŸ›‘ Stopping production services..."
	docker-compose -f docker-compose.prod.yml down
	@echo "âœ… Production services stopped"

# View production logs
prod-logs:
	@echo "ğŸ“œ Viewing production logs (Ctrl+C to exit)..."
	docker-compose -f docker-compose.prod.yml logs -f

# Open shell in production backend
prod-shell:
	@echo "ğŸš Opening shell in production backend container..."
	docker-compose -f docker-compose.prod.yml exec backend /bin/bash

# Production database migrate
prod-db-migrate:
	@echo "ğŸ”„ Running production database migrations..."
	docker-compose -f docker-compose.prod.yml exec backend alembic upgrade head
	@echo "âœ… Production migrations complete"

# Production quick start
prod-start: prod-build prod-up prod-db-migrate
	@echo "âœ¨ Production application started successfully!"
	@echo "ğŸ“ Visit http://localhost:8000/docs"
